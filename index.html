<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CaseBattle Store TWA</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Палитра Case-Battle.store */
            --bg-body: #13151b;
            --bg-header: #1b1e28;
            --bg-card: #1b1e28;
            --bg-input: #111217;
            
            --accent-orange: #fca505;
            --accent-orange-hover: #ffb830;
            --accent-purple: #6c5dd3;
            --accent-green: #00c74d;
            --accent-red: #ff3b30;
            
            --text-main: #ffffff;
            --text-muted: #6e7485;
            
            /* Редкости (цвета полосок) */
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ce6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #e4ae39;

            --nav-height: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Rubik', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- LIVE FEED (ЛЕНТА) --- */
        .live-bar {
            height: 65px;
            background: #101116;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            z-index: 20;
        }
        .live-track {
            display: flex;
            gap: 2px;
            animation: scroll 30s linear infinite;
        }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        .live-item {
            width: 90px; height: 65px;
            background: linear-gradient(180deg, rgba(30,33,43,0.5) 0%, rgba(19,21,27,0.8) 100%);
            display: flex; align-items: center; justify-content: center;
            position: relative;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
        }
        .live-item:hover { background: #252833; }
        .live-item img { width: 60px; height: 45px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }

        /* --- HEADER --- */
        header {
            height: 70px;
            background: var(--bg-header);
            padding: 0 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .logo { 
            font-weight: 900; font-size: 20px; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 5px;
        }
        .logo span:first-child { color: #fff; }
        .logo span:last-child { color: var(--accent-orange); background: -webkit-linear-gradient(45deg, #fca505, #ff7a00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .balance-wrap {
            background: #111217;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #2a2d3a;
            display: flex; align-items: center; gap: 10px;
        }
        .balance-val { font-weight: 700; font-size: 15px; color: #fff; }
        .balance-add {
            width: 24px; height: 24px;
            background: linear-gradient(90deg, var(--accent-orange), #ff7a00);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            color: #000; font-size: 12px; cursor: pointer;
            box-shadow: 0 0 10px rgba(252, 165, 5, 0.3);
        }

        /* --- MAIN CONTENT --- */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 12px 100px;
        }

        .section-title {
            font-size: 18px; font-weight: 800; color: #fff; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
            text-transform: uppercase;
        }
        .section-title i { color: var(--accent-orange); }

        /* --- CASES GRID --- */
        .cases-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
        }
        
        .case-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }
        .case-card:active { transform: scale(0.98); }
        /* Эффект свечения при наведении (имитация) */
        .case-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(108, 93, 211, 0.15) 0%, transparent 70%);
            opacity: 0.5;
        }
        
        .case-img { width: 100px; height: 90px; object-fit: contain; margin-bottom: 10px; z-index: 2; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5)); transition: 0.3s; }
        
        .case-info { z-index: 2; width: 100%; text-align: center; }
        .case-name { font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .case-btn {
            background: #252833;
            color: #fff;
            padding: 8px 0;
            width: 100%;
            border-radius: 6px;
            font-weight: 700; font-size: 13px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .case-card:hover .case-btn { background: var(--accent-orange); color: #000; border-color: var(--accent-orange); box-shadow: 0 0 15px rgba(252, 165, 5, 0.4); }

        /* --- ROULETTE MODAL (Full Screen) --- */
        .roulette-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(19, 21, 27, 0.98);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .roulette-container {
            width: 100%;
            height: 160px;
            background: #16181f;
            position: relative;
            border-top: 2px solid var(--accent-orange);
            border-bottom: 2px solid var(--accent-orange);
            margin-bottom: 30px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        /* Центральная линия */
        .roulette-pointer {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
            background: var(--accent-orange);
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 10px var(--accent-orange);
        }
        .roulette-pointer::after {
            content: '▼'; position: absolute; top: -10px; left: -6px; color: var(--accent-orange); font-size: 12px;
        }
        .roulette-pointer::before {
            content: '▲'; position: absolute; bottom: -10px; left: -6px; color: var(--accent-orange); font-size: 12px;
        }

        .roulette-strip {
            display: flex;
            height: 100%;
            align-items: center;
            will-change: transform;
        }
        
        .roulette-item {
            min-width: 130px;
            height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid rgba(255,255,255,0.05);
            position: relative;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }
        .roulette-item img { width: 90px; height: 70px; object-fit: contain; margin-bottom: 10px; z-index: 2; }
        .roulette-item::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        }

        /* --- WIN MODAL --- */
        .win-display {
            text-align: center; opacity: 0; transform: translateY(20px); transition: 0.5s; pointer-events: none;
        }
        .win-display.active { opacity: 1; transform: translateY(0); pointer-events: all; }
        
        .win-img-wrapper {
            position: relative; width: 160px; height: 120px; margin: 0 auto 20px;
        }
        .win-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
        
        .win-name { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 5px; text-transform: uppercase; }
        .win-price { font-size: 20px; font-weight: 900; color: var(--accent-green); margin-bottom: 25px; }
        
        .action-btn {
            background: #2a2d3a;
            color: #fff;
            border: none;
            padding: 14px 40px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            width: 100%;
            margin-bottom: 10px;
        }
        .btn-green { background: var(--accent-green); color: #000; box-shadow: 0 4px 15px rgba(0, 199, 77, 0.4); }
        .btn-sell { background: var(--accent-orange); color: #000; box-shadow: 0 4px 15px rgba(252, 165, 5, 0.4); }

        /* --- BATTLE MODE --- */
        .battle-ui { display: flex; gap: 5px; margin-top: 10px; }
        .battle-col { flex: 1; background: #16181f; border-radius: 8px; overflow: hidden; border: 1px solid #2a2d3a; }
        .col-header { padding: 10px; background: #1b1e28; border-bottom: 1px solid #2a2d3a; display: flex; align-items: center; justify-content: space-between; }
        .col-avatar { width: 30px; height: 30px; border-radius: 6px; background: #333; }
        
        .slot-item {
            height: 80px; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.05); position: relative;
        }
        .slot-item img { width: 60px; height: 50px; object-fit: contain; }
        .slot-item.winner { background: rgba(0, 199, 77, 0.1); box-shadow: inset 3px 0 0 var(--accent-green); }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: #1b1e28;
            border-top: 1px solid #2a2d3a;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50; padding-bottom: 10px;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-muted); font-size: 10px; font-weight: 600; width: 20%; transition: 0.2s;
        }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: #fff; }
        .nav-item.active i { color: var(--accent-purple); transform: translateY(-3px); filter: drop-shadow(0 0 8px var(--accent-purple)); }
        
        /* Central Button */
        .nav-center {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent-purple), #8e2de2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 25px;
            border: 4px solid var(--bg-body);
            box-shadow: 0 0 15px rgba(108, 93, 211, 0.5);
        }
        .nav-center i { color: #fff; font-size: 22px; }

        /* Helpers */
        .hidden { display: none !important; }
        .text-gold { color: var(--accent-orange); }
        .text-green { color: var(--accent-green); }
        
        /* Rarities Colors */
        .r-blue { color: var(--rarity-blue); } .bg-r-blue { background: var(--rarity-blue); }
        .r-purple { color: var(--rarity-purple); } .bg-r-purple { background: var(--rarity-purple); }
        .r-pink { color: var(--rarity-pink); } .bg-r-pink { background: var(--rarity-pink); }
        .r-red { color: var(--rarity-red); } .bg-r-red { background: var(--rarity-red); }
        .r-gold { color: var(--rarity-gold); } .bg-r-gold { background: var(--rarity-gold); }

        /* Rarity Underlines */
        .roulette-item.r-blue::after { background: var(--rarity-blue); box-shadow: 0 -2px 10px var(--rarity-blue); }
        .roulette-item.r-purple::after { background: var(--rarity-purple); box-shadow: 0 -2px 10px var(--rarity-purple); }
        .roulette-item.r-pink::after { background: var(--rarity-pink); box-shadow: 0 -2px 10px var(--rarity-pink); }
        .roulette-item.r-red::after { background: var(--rarity-red); box-shadow: 0 -2px 10px var(--rarity-red); }
        .roulette-item.r-gold::after { background: var(--rarity-gold); box-shadow: 0 -2px 10px var(--rarity-gold); }

        .live-item[data-rarity="r-blue"] { border-bottom-color: var(--rarity-blue); }
        .live-item[data-rarity="r-purple"] { border-bottom-color: var(--rarity-purple); }
        .live-item[data-rarity="r-pink"] { border-bottom-color: var(--rarity-pink); }
        .live-item[data-rarity="r-red"] { border-bottom-color: var(--rarity-red); }
        .live-item[data-rarity="r-gold"] { border-bottom-color: var(--rarity-gold); }

    </style>
</head>
<body>

    <div class="live-bar">
        <div class="live-track" id="live-feed"></div>
    </div>

    <header>
        <div class="logo">
            <span>CASE</span><span>BATTLE</span>
        </div>
        <div class="balance-wrap" onclick="addMoney()">
            <div class="balance-val" id="balance">0.00</div>
            <div class="balance-add"><i class="fa-solid fa-plus"></i></div>
        </div>
    </header>

    <div id="view-home" class="content">
        <div class="section-title"><i class="fa-solid fa-fire"></i> Популярные кейсы</div>
        <div class="cases-grid" id="cases-list"></div>
    </div>

    <div id="view-battles" class="content hidden">
        <div class="section-title"><i class="fa-solid fa-swords"></i> Батлы</div>
        <div style="background: #1b1e28; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
            <p style="color: #6e7485; font-size: 13px; margin-bottom: 15px;">Создай битву 1 на 1 против бота</p>
            <button class="action-btn btn-green" onclick="startBattle()">Создать за 100.00</button>
        </div>

        <div id="battle-area" class="hidden">
            <div class="battle-ui">
                <div class="battle-col" id="col-user">
                    <div class="col-header">
                        <img id="battle-user-ava" src="" class="col-avatar">
                        <span style="font-size: 12px; font-weight: bold; color:#fff">YOU</span>
                        <span class="text-green" id="score-user">0.00</span>
                    </div>
                </div>
                <div class="battle-col" id="col-bot">
                    <div class="col-header">
                        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" class="col-avatar">
                        <span style="font-size: 12px; font-weight: bold; color:#fff">BOT</span>
                        <span class="text-green" id="score-bot">0.00</span>
                    </div>
                </div>
            </div>
            <div id="battle-res" style="text-align: center; margin-top: 15px; font-size: 22px; font-weight: 900; text-transform: uppercase;"></div>
        </div>
    </div>

    <div id="view-profile" class="content hidden">
        <div style="text-align: center; margin-bottom: 30px;">
            <img id="profile-ava" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent-purple); padding: 3px;">
            <h2 id="profile-name" style="margin-top: 10px; font-size: 20px;">User</h2>
            <div style="color: #6e7485; font-size: 12px; margin-top: 5px;">ID: 7656119...</div>
        </div>
        <div class="section-title"><i class="fa-solid fa-box"></i> Инвентарь</div>
        <div class="cases-grid" id="inventory-list" style="grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
    </div>

    <div class="roulette-modal" id="modal">
        <div class="roulette-container">
            <div class="roulette-pointer"></div>
            <div class="roulette-strip" id="strip"></div>
        </div>
        
        <div class="win-display" id="win-block">
            <div style="color: #6e7485; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; font-weight: 600;">Вы выиграли</div>
            <div class="win-img-wrapper">
                <img id="win-img" src="" class="win-img">
            </div>
            <div id="win-name" class="win-name">AK-47 | Asiimov</div>
            <div id="win-price" class="win-price">4500.00</div>
            
            <button class="action-btn btn-green" onclick="closeModal()">В инвентарь</button>
            <button class="action-btn btn-sell" onclick="sellItem()">Продать</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="fa-solid fa-box-open"></i>
            <span>Главная</span>
        </div>
        <div class="nav-item" onclick="switchTab('battles', this)">
            <i class="fa-solid fa-users"></i>
            <span>Батлы</span>
        </div>
        <div class="nav-item" onclick="switchTab('home', this)">
             <div class="nav-center">
                <i class="fa-solid fa-plus"></i>
            </div>
        </div>
        <div class="nav-item" onclick="switchTab('upgrades', this)">
            <i class="fa-solid fa-arrow-up-right-dots"></i>
            <span>Апгрейд</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <i class="fa-solid fa-user"></i>
            <span>Профиль</span>
        </div>
    </nav>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#1b1e28');

    // --- MOCK DATA ---
    // Используем реальные изображения скинов CS2 из Steam CDN
    const SKINS = [
        { name: "AWP | Dragon Lore", price: 150000, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7cQFQq78dy27iR9tWmiQPj_0U9YmGid9eSI1c7MFvW_we6w-q618S575XAnCRj6yBw4X-OmAv330-J8wytYA/360fx360f" },
        { name: "M4A4 | Howl", price: 120000, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhz2v_Nfz5H_uO1gb-Gw_alIImJwlRc7cF4n-SPpI-i3Aew_0o5YT2iJNfHclM5YQzU_gK7wO7mg8C0u5rKzCdg7yYk5XfUmEeyhQYMMLIki7Zt0g/360fx360f" },
        { name: "AK-47 | Gold Arabesque", price: 80000, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjxszJemkV09-5lpKKqPv9NLPF2G0D78Y_3r2Z8I2i0Qq1_kFsY2z1d9CWelI2ZQqF-gS9w-a8h5S5vJ3MzSF9-n51Yx0r-Z4/360fx360f" },
        { name: "Karambit | Fade", price: 90000, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLwJf0ebcZThQ6tCvq4GGqPP7I6vdk3lu-M1wmeyTyo78i0fvrxc5Mm_wI4fGcA89MlqB_FDrw-_ngpC5vpzJyyRiuSQm-z-DyBCA4k0T/360fx360f" },
        { name: "Glock-18 | Fade", price: 40000, rarity: "r-purple", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgposbaqKAxf0v73efTH9eO7fYK0m_7zO6-fz2oI7pEjiLjHpo6n3g3t_kFtYTz1I46UJAQ-Y13Xq1Xvxe_v0cW5vJzJmnR9-n51-q3gWvI/360fx360f" },
        { name: "USP-S | Kill Confirmed", price: 15000, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpoo6m1FBRp3_bGcjhQ09-jq5WYh8j_OrfdqWhe5sN4mTEyT48t2r2xK60x2Q/360fx360f" },
        { name: "AK-47 | Asiimov", price: 8000, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjxszJemkV092lnYmGm_PLP7LWnn8f65dw3OyS942l3AGy80s4ZDygJOSWclQ3Ml_Q-lO8xua-jJK0uJvKz3Jj6yRz4i7D30vgF82Fm4E/360fx360f" },
        { name: "M4A1-S | Printstream", price: 12000, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhz2v_Nfz5H_uO1gb-Gw_alIImJwlRc7cF4n-SPpI-i3Aew_0o5YT2iJNfHclM5YQzU_gK7wO7mg8C0u5rKzCdg7yYk5XfUmEeyhQYMMLIki7Zt0g/360fx360f" },
        { name: "P250 | Asiimov", price: 1500, rarity: "r-pink", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpopujwezhz3fzcdD5D09Lhh5O0h_L4PbzXmG9u5Mx2gv2P9I_zj126lBE9YmD0LI6QJgI4M1rR_VG6w-a70Z606pydwXsw7iInt33UgVXp1iE6l2r4/360fx360f" },
        { name: "AWP | Atheris", price: 1000, rarity: "r-blue", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJU5cy4gYyaqPjxhFlc5cN5t-rN_Iv9nB21rxFqY2r7coKRIFQ9ZgvU-1Pox-fv1p68u5mfmHsy6Sgg-z-DyIVN_-M0/360fx360f" }
    ];

    const CASES = [
        { id: 1, name: "Бомж Кейс", price: 100, img: "https://cdn-icons-png.flaticon.com/512/9329/9329199.png", pool: [9, 9, 8, 9, 8] },
        { id: 2, name: "Тайное", price: 5000, img: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png", pool: [7, 5, 2, 7, 6] },
        { id: 3, name: "Мажор", price: 15000, img: "https://cdn-icons-png.flaticon.com/512/644/644667.png", pool: [4, 2, 1, 3] },
        { id: 4, name: "Ножи", price: 50000, img: "https://cdn-icons-png.flaticon.com/512/9626/9626643.png", pool: [3, 4, 1] }
    ];

    let balance = 2000.00;
    let inventory = [];
    let currentWin = null;

    // --- INIT ---
    function init() {
        const user = tg.initDataUnsafe.user;
        if(user) {
            document.getElementById('profile-name').innerText = user.first_name || 'User';
            if(user.photo_url) {
                document.getElementById('profile-ava').src = user.photo_url;
                document.getElementById('battle-user-ava').src = user.photo_url;
            }
        }
        updateBalance();
        renderCases();
        startLiveFeed();
    }

    function updateBalance() {
        document.getElementById('balance').innerText = balance.toFixed(2);
    }
    
    function addMoney() {
        balance += 10000;
        updateBalance();
        tg.showPopup({message: 'Баланс пополнен на 10,000 (Demo)'});
    }

    // --- RENDER ---
    function renderCases() {
        const grid = document.getElementById('cases-list');
        grid.innerHTML = CASES.map(c => `
            <div class="case-card">
                <img src="${c.img}" class="case-img">
                <div class="case-info">
                    <div class="case-name">${c.name}</div>
                </div>
                <button class="case-btn" onclick="openCase(${c.id})">${c.price.toFixed(0)}</button>
            </div>
        `).join('');
    }

    // --- LIVE FEED ---
    function startLiveFeed() {
        const track = document.getElementById('live-feed');
        for(let i=0; i<30; i++) addLiveItem(track);
        setInterval(() => addLiveItem(track), 1500);
    }

    function addLiveItem(track) {
        const item = SKINS[Math.floor(Math.random() * SKINS.length)];
        const div = document.createElement('div');
        div.className = 'live-item';
        div.setAttribute('data-rarity', item.rarity);
        div.innerHTML = `<img src="${item.img}">`;
        
        track.insertBefore(div, track.firstChild);
        if(track.children.length > 50) track.removeChild(track.lastChild);
    }

    // --- ROULETTE LOGIC ---
    function openCase(id) {
        const c = CASES.find(x => x.id === id);
        if(balance < c.price) return tg.showAlert("Недостаточно средств!");
        
        balance -= c.price;
        updateBalance();

        const modal = document.getElementById('modal');
        const strip = document.getElementById('strip');
        const winBlock = document.getElementById('win-block');

        modal.style.display = 'flex';
        winBlock.classList.remove('active');
        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0)';

        // Генерация ленты
        let items = [];
        for(let i=0; i<60; i++) {
            let skinId = c.pool[Math.floor(Math.random() * c.pool.length)];
            items.push(SKINS[skinId]);
        }
        
        // Победитель на 45 позиции
        const winIdx = 45;
        currentWin = items[winIdx];

        strip.innerHTML = items.map(item => `
            <div class="roulette-item ${item.rarity}">
                <img src="${item.img}">
            </div>
        `).join('');

        // Анимация
        setTimeout(() => {
            const itemWidth = 130;
            const offset = (winIdx * itemWidth) - (window.innerWidth / 2) + (itemWidth / 2);
            const rand = Math.floor(Math.random() * 80) - 40; // Рандом внутри карточки
            
            strip.style.transition = 'transform 6s cubic-bezier(0.1, 1, 0.3, 1)'; // Плавное замедление (Physics)
            strip.style.transform = `translateX(-${offset + rand}px)`;
            
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
            
            setTimeout(() => {
                showWin(currentWin);
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }, 6000);
        }, 50);
    }

    function showWin(item) {
        document.getElementById('win-img').src = item.img;
        document.getElementById('win-name').innerText = item.name;
        document.getElementById('win-price').innerText = item.price.toFixed(2);
        document.getElementById('win-price').className = `win-price ${item.rarity.replace('r-', 'text-')}`;
        document.getElementById('win-block').classList.add('active');
    }

    function closeModal() {
        inventory.push(currentWin);
        renderInventory();
        document.getElementById('modal').style.display = 'none';
    }

    function sellItem() {
        balance += currentWin.price;
        updateBalance();
        document.getElementById('modal').style.display = 'none';
    }

    // --- BATTLES LOGIC ---
    function startBattle() {
        if(balance < 100) return tg.showAlert("Нужно 100.00");
        balance -= 100;
        updateBalance();

        document.getElementById('battle-area').classList.remove('hidden');
        document.getElementById('battle-res').innerText = '';
        
        const uCol = document.getElementById('col-user');
        const bCol = document.getElementById('col-bot');
        
        // Очистка слотов
        while(uCol.children.length > 1) uCol.removeChild(uCol.lastChild);
        while(bCol.children.length > 1) bCol.removeChild(bCol.lastChild);

        let round = 0;
        let uTotal = 0, bTotal = 0;

        const interval = setInterval(() => {
            round++;
            const uItem = SKINS[Math.floor(Math.random() * SKINS.length)];
            const bItem = SKINS[Math.floor(Math.random() * SKINS.length)];
            
            uTotal += uItem.price;
            bTotal += bItem.price;
            
            document.getElementById('score-user').innerText = uTotal.toFixed(2);
            document.getElementById('score-bot').innerText = bTotal.toFixed(2);

            addBattleSlot(uCol, uItem, uItem.price >= bItem.price);
            addBattleSlot(bCol, bItem, bItem.price > uItem.price);

            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            if(round >= 5) {
                clearInterval(interval);
                const win = uTotal >= bTotal;
                const res = document.getElementById('battle-res');
                res.innerText = win ? "ПОБЕДА" : "ПОРАЖЕНИЕ";
                res.style.color = win ? "var(--accent-green)" : "var(--accent-red)";
                
                if(win) {
                    balance += (uTotal + bTotal);
                    updateBalance();
                }
            }
        }, 1500);
    }

    function addBattleSlot(col, item, win) {
        const div = document.createElement('div');
        div.className = `slot-item ${win ? 'winner' : ''}`;
        div.innerHTML = `<img src="${item.img}">`;
        col.appendChild(div);
    }

    // --- INVENTORY ---
    function renderInventory() {
        const grid = document.getElementById('inventory-list');
        grid.innerHTML = inventory.map(item => `
            <div class="case-card" style="padding:10px;">
                <img src="${item.img}" style="width:60px; height:50px; object-fit:contain;">
                <div style="font-size:10px; margin-top:5px; white-space:nowrap; overflow:hidden; width:100%">${item.name}</div>
                <div style="font-size:11px; font-weight:bold; color:var(--accent-green)">${item.price.toFixed(0)}</div>
            </div>
        `).join('');
    }

    // --- NAVIGATION ---
    function switchTab(tab, el) {
        document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        if(tab === 'home') document.getElementById('view-home').classList.remove('hidden');
        if(tab === 'battles') document.getElementById('view-battles').classList.remove('hidden');
        if(tab === 'profile') document.getElementById('view-profile').classList.remove('hidden');
        
        if(el) el.classList.add('active');
        if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    }

    // Init
    init();

</script>
</body>
</html>
