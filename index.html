<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. ADAPTIVE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary: #00f2ff;
            --alert: #ff003c;
            --bg: #050a10;
            --glass: rgba(0, 242, 255, 0.1);
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #0d1b2a 0%, #000 90%);
        }

        /* HEADER */
        .header {
            padding: 15px; border-bottom: 1px solid rgba(0, 242, 255, 0.2);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
        }

        /* TERMINAL */
        .terminal {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }
        .msg {
            padding: 12px; border-radius: 8px; max-width: 90%; word-wrap: break-word; animation: fadeIn 0.3s;
        }
        .msg.jarvis { border-left: 3px solid var(--primary); background: linear-gradient(90deg, var(--glass), transparent); align-self: flex-start; }
        .msg.user { border-right: 3px solid #fff; background: rgba(255,255,255,0.05); align-self: flex-end; text-align: right; }
        .msg.sys { font-size: 0.8em; color: #888; text-align: center; width: 100%; align-self: center; border: 1px dashed #333; padding: 5px; }

        /* CODE */
        pre { background: #0b1015; padding: 10px; border: 1px solid #333; overflow-x: auto; border-radius: 5px; }
        code { font-family: 'Fira Code', monospace; color: #7ecaff; font-size: 0.85em; }

        /* REACTOR */
        .reactor-container {
            height: 240px; display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle, rgba(0,242,255,0.05) 0%, transparent 60%);
        }
        .arc {
            width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--primary);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 0 20px var(--primary); transition: 0.3s; background: rgba(0,0,0,0.5);
            font-size: 24px;
        }
        .arc:active { transform: scale(0.95); }
        .arc.busy { border-color: #ffd700; box-shadow: 0 0 40px #ffd700; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* SETTINGS */
        #settings {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 99; justify-content: center; align-items: center; flex-direction: column;
        }
        .panel { width: 85%; max-width: 400px; text-align: center; border: 1px solid var(--primary); padding: 20px; background: #080f16; }
        input { width: 100%; padding: 12px; margin: 15px 0; background: #000; border: 1px solid #444; color: #fff; text-align: center; }
        button { width: 100%; padding: 12px; margin-top: 10px; background: var(--glass); color: var(--primary); border: 1px solid var(--primary); cursor: pointer; font-weight: bold; }
        button.check-btn { border-color: #ffd700; color: #ffd700; }

    </style>
</head>
<body>

    <div class="header">
        <div style="font-family:'Orbitron'; font-weight:900">J.A.R.V.I.S. <span style="font-size:0.6em; opacity:0.7">ADAPTIVE</span></div>
        <i class="fas fa-cog" onclick="ui.toggleSettings()"></i>
    </div>

    <div class="terminal" id="term">
        <div class="msg jarvis">
            <strong>SYSTEM ONLINE.</strong><br>
            Нажмите на шестеренку и запустите "SYSTEM CHECK", чтобы я нашел доступную модель.
        </div>
    </div>

    <div class="reactor-container">
        <div class="arc" id="mic"><i class="fas fa-microphone"></i></div>
    </div>

    <div id="settings">
        <div class="panel">
            <h3>CONFIGURATION</h3>
            <input type="text" id="apikey" placeholder="Paste API Key here...">
            <button onclick="core.saveKey()">SAVE KEY</button>
            <button class="check-btn" onclick="core.autoDiscover()">RUN SYSTEM CHECK (AUTO-FIX)</button>
            <button onclick="ui.toggleSettings()" style="border:none; margin-top:10px; font-size:0.8em">CLOSE</button>
            <div id="status-log" style="font-size:0.7em; margin-top:10px; color:#888; text-align:left; max-height:100px; overflow:auto"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- CORE SYSTEM ---
        const core = {
            key: localStorage.getItem('jarvis_key') || '',
            model: localStorage.getItem('jarvis_model') || 'gemini-1.5-flash',
            
            saveKey: () => {
                const val = document.getElementById('apikey').value.trim();
                if(val.length < 10) return alert("Key too short");
                core.key = val;
                localStorage.setItem('jarvis_key', val);
                ui.log("Key saved. Running diagnostic...", "sys");
                core.autoDiscover();
            },

            // ГЛАВНАЯ ФИШКА: Автопоиск рабочей модели
            autoDiscover: async () => {
                if(!core.key) return alert("First, save the API Key!");
                const status = document.getElementById('status-log');
                status.innerHTML = "Scanning available models...";
                
                try {
                    // 1. Запрашиваем список всех моделей
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${core.key}`);
                    const data = await res.json();

                    if(data.error) throw new Error(data.error.message);
                    if(!data.models) throw new Error("No models returned list");

                    // 2. Ищем лучшую доступную
                    // Приоритет: 1.5-flash -> 1.5-pro -> 1.0-pro
                    let found = null;
                    const available = data.models.map(m => m.name); // Получаем список типа models/gemini-pro
                    
                    status.innerHTML += "<br>Found: " + available.length + " models.";

                    if(available.some(n => n.includes('gemini-1.5-flash'))) found = 'gemini-1.5-flash';
                    else if(available.some(n => n.includes('gemini-1.5-pro'))) found = 'gemini-1.5-pro';
                    else if(available.some(n => n.includes('gemini-pro'))) found = 'gemini-pro';
                    else if(available.some(n => n.includes('gemini-1.0-pro'))) found = 'gemini-1.0-pro';

                    if(found) {
                        core.model = found;
                        localStorage.setItem('jarvis_model', found);
                        status.innerHTML += `<br><span style="color:#0f0">CONNECTED TO: ${found}</span>`;
                        ui.log(`SYSTEM CALIBRATED.<br>Active Core: <b>${found}</b>`, "jarvis");
                        setTimeout(() => ui.toggleSettings(), 1500);
                    } else {
                        status.innerHTML += `<br><span style="color:red">NO COMPATIBLE CHAT MODELS FOUND.</span>`;
                        alert("Google вернул список моделей, но в нем нет текстовых (generateContent). Проверьте права ключа.");
                    }

                } catch(e) {
                    status.innerHTML += `<br><span style="color:red">ERROR: ${e.message}</span>`;
                    ui.log("DIAGNOSTIC FAILED: " + e.message, "sys");
                }
            },

            process: async (text) => {
                if(!core.key) { ui.toggleSettings(); return; }
                ui.setBusy(true);

                try {
                    // Используем автоматически найденную модель
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${core.model}:generateContent?key=${core.key}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Ты J.A.R.V.I.S. Помощник. Отвечай кратко на русском. " + text }] }]
                        })
                    });

                    const data = await response.json();
                    
                    if(data.error) {
                        // Если ошибка 404, значит модель устарела, запускаем автопоиск
                        if(data.error.code === 404) {
                            ui.log("Model mismatch. Auto-fixing...", "sys");
                            await core.autoDiscover();
                            throw new Error("Re-calibrating... Try again.");
                        }
                        throw new Error(data.error.message);
                    }

                    const raw = data.candidates[0].content.parts[0].text;
                    ui.log(marked.parse(raw), "jarvis");
                    voice.speak(raw.replace(/[*#`]/g, ''));

                } catch(e) {
                    ui.log(e.message, "sys");
                    tg.HapticFeedback.notificationOccurred('error');
                } finally {
                    ui.setBusy(false);
                }
            }
        };

        // --- UI & TOOLS ---
        const ui = {
            mic: document.getElementById('mic'),
            term: document.getElementById('term'),
            settings: document.getElementById('settings'),
            
            log: (html, type) => {
                const d = document.createElement('div');
                d.className = `msg ${type}`;
                d.innerHTML = html;
                ui.term.appendChild(d);
                setTimeout(()=>ui.term.scrollTop = ui.term.scrollHeight, 100);
            },
            
            toggleSettings: () => {
                const show = ui.settings.style.display !== 'flex';
                ui.settings.style.display = show ? 'flex' : 'none';
                if(show && core.key) document.getElementById('apikey').value = core.key;
            },
            
            setBusy: (isBusy) => {
                ui.mic.className = isBusy ? 'arc busy' : 'arc';
            }
        };

        const voice = {
            speak: (txt) => {
                if(!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt.substring(0, 200));
                u.lang = 'ru-RU';
                window.speechSynthesis.speak(u);
            }
        };

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            const rec = new SpeechRecognition();
            rec.lang = 'ru-RU';
            
            ui.mic.onclick = () => {
                if(ui.mic.classList.contains('busy')) return;
                try { rec.start(); tg.HapticFeedback.impactOccurred('medium'); } 
                catch(e) { rec.stop(); }
            };
            
            rec.onstart = () => ui.mic.style.boxShadow = "0 0 50px #fff";
            rec.onend = () => ui.mic.style.boxShadow = "";
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                if(txt.trim()) {
                    ui.log(txt, "user");
                    core.process(txt);
                }
            };
        } else {
            ui.log("Voice input not supported", "sys");
        }

        // Auto-check on load if key exists but model is unknown
        if(core.key && !localStorage.getItem('jarvis_model')) {
            setTimeout(core.autoDiscover, 1000);
        } else if(!core.key) {
            setTimeout(ui.toggleSettings, 500);
        }

    </script>
</body>
</html>
