<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CS2 Case Battle</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800;900&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Case Battle Palette */
            --bg-dark: #121212;
            --bg-darker: #0d0d0d;
            --bg-panel: #1e1e24;
            --bg-card: #18181d;
            
            --accent-green: #00fa9a;
            --accent-green-dim: rgba(0, 250, 154, 0.1);
            --accent-purple: #8a2be2;
            --accent-red: #ff4500;
            --accent-gold: #ffd700;
            
            --text-main: #ffffff;
            --text-muted: #6c757d;
            
            /* Rarities */
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ce6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #e4ae39;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Exo 2', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- LIVE DROP FEED --- */
        .live-strip {
            height: 60px;
            background: var(--bg-darker);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            z-index: 20;
        }
        .live-track {
            display: flex;
            gap: 2px;
            animation: infiniteScroll 30s linear infinite;
        }
        @keyframes infiniteScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        .live-item {
            width: 80px; height: 60px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0.2) 100%);
            display: flex; align-items: center; justify-content: center;
            position: relative;
            border-bottom: 2px solid transparent;
        }
        .live-item img { width: 50px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        
        /* --- HEADER --- */
        header {
            padding: 12px 16px;
            background: var(--bg-panel);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .logo { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 18px; letter-spacing: -0.5px; }
        .logo span { color: var(--accent-green); }
        
        .wallet {
            background: rgba(0,0,0,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--accent-green-dim);
            color: var(--accent-green);
            font-weight: 700; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .wallet-add { background: var(--accent-green); color: #000; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }

        /* --- CONTENT AREA --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 12px 100px 12px;
        }

        .section-header {
            font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .section-header::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }

        /* --- CASES GRID --- */
        .cases-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .case-card {
            background: var(--bg-card);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
        }
        .case-card:active { transform: scale(0.98); }
        .case-card:hover { border-color: rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        .case-img { width: 110px; height: 80px; object-fit: contain; margin-bottom: 10px; z-index: 2; transition: transform 0.3s; }
        .case-card:hover .case-img { transform: scale(1.1) rotate(5deg); }
        
        .case-info { text-align: center; z-index: 2; width: 100%; }
        .case-name { font-size: 13px; font-weight: 600; color: #ccc; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .case-price { font-size: 14px; font-weight: 800; color: var(--text-main); }
        
        /* Glow Effect for Cases */
        .case-card::before {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            z-index: 1;
        }

        /* --- ROULETTE MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,10,0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .roulette-wrapper {
            width: 100%;
            height: 140px;
            background: #151515;
            position: relative;
            border-top: 2px solid var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .roulette-center-line {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
            background: var(--accent-gold);
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 10px var(--accent-gold);
        }
        
        .roulette-tape {
            display: flex;
            height: 100%;
            align-items: center;
            will-change: transform;
        }
        
        .tape-item {
            width: 120px; flex-shrink: 0;
            height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        .tape-item img { width: 90px; height: 70px; object-fit: contain; z-index: 2; }
        .tape-item::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        }

        .win-card {
            background: #222; border: 1px solid #333; padding: 20px; border-radius: 12px; text-align: center;
            opacity: 0; transform: translateY(20px); transition: 0.5s;
            max-width: 80%;
        }
        .win-card.visible { opacity: 1; transform: translateY(0); }
        
        .btn-action {
            margin-top: 15px; padding: 12px 30px; border: none; border-radius: 4px;
            font-family: 'Exo 2'; font-weight: 800; font-size: 14px; text-transform: uppercase;
            cursor: pointer; width: 100%;
        }
        .btn-green { background: var(--accent-green); color: #000; box-shadow: 0 4px 15px rgba(0, 250, 154, 0.3); }
        .btn-sell { background: #333; color: #fff; margin-top: 10px; }

        /* --- BATTLE UI --- */
        .battle-container { display: flex; gap: 8px; width: 100%; }
        .battle-col { flex: 1; background: var(--bg-card); border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .battle-header { padding: 10px; background: rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #333; }
        .avatar { width: 24px; height: 24px; border-radius: 4px; background: #555; object-fit: cover; }
        .battle-total { margin-left: auto; font-weight: 700; color: var(--accent-green); font-size: 12px; }
        
        .battle-slot {
            height: 90px;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        .battle-slot img { width: 70px; height: 50px; object-fit: contain; }
        .battle-slot.empty { background: rgba(0,0,0,0.2); }
        .battle-slot.winner { box-shadow: inset 0 0 15px rgba(0, 250, 154, 0.3); border-left: 2px solid var(--accent-green); }
        .battle-slot.loser { opacity: 0.5; }

        /* --- UPGRADE UI --- */
        .upgrade-wrapper {
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        .circle-container {
            width: 260px; height: 260px; position: relative; margin: 30px 0;
        }
        .upgrade-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: #2a2a2a; stroke-width: 15; }
        .circle-progress { fill: none; stroke: var(--accent-green); stroke-width: 15; stroke-dasharray: 753; stroke-dashoffset: 753; transition: stroke-dashoffset 0.3s; }
        
        .pointer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
            transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1);
        }
        .pointer::after {
            content: ''; position: absolute; top: 5px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #fff;
        }

        .multipliers { display: flex; gap: 10px; margin-bottom: 20px; }
        .mult-btn {
            background: #2a2a2a; color: #888; border: 1px solid transparent; padding: 8px 16px; border-radius: 4px; font-weight: 700; font-family: 'Exo 2';
        }
        .mult-btn.active { background: rgba(0, 250, 154, 0.1); color: var(--accent-green); border-color: var(--accent-green); }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--bg-panel);
            border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50; padding-bottom: 10px; /* Safe area */
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #555; font-size: 10px; font-weight: 700; width: 20%;
        }
        .nav-item i { font-size: 20px; transition: 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active i { color: var(--accent-green); transform: translateY(-3px); text-shadow: 0 0 10px var(--accent-green); }

        /* --- RARITY CLASSES --- */
        .r-blue { color: var(--rarity-blue) !important; border-color: var(--rarity-blue) !important; }
        .r-purple { color: var(--rarity-purple) !important; border-color: var(--rarity-purple) !important; }
        .r-pink { color: var(--rarity-pink) !important; border-color: var(--rarity-pink) !important; }
        .r-red { color: var(--rarity-red) !important; border-color: var(--rarity-red) !important; }
        .r-gold { color: var(--rarity-gold) !important; border-color: var(--rarity-gold) !important; }
        
        .tape-item.r-red::after { background: var(--rarity-red); box-shadow: 0 -5px 15px var(--rarity-red); }
        .tape-item.r-pink::after { background: var(--rarity-pink); box-shadow: 0 -5px 15px var(--rarity-pink); }
        .tape-item.r-purple::after { background: var(--rarity-purple); box-shadow: 0 -5px 15px var(--rarity-purple); }
        .tape-item.r-blue::after { background: var(--rarity-blue); box-shadow: 0 -5px 15px var(--rarity-blue); }
        .tape-item.r-gold::after { background: var(--rarity-gold); box-shadow: 0 -5px 15px var(--rarity-gold); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="live-strip">
        <div class="live-track" id="live-feed"></div>
    </div>

    <header>
        <div class="logo">CASE<span>BATTLE</span></div>
        <div class="wallet" onclick="addFunds()">
            <span id="balance">0.00</span>
            <div class="wallet-add"><i class="fa-solid fa-plus"></i></div>
        </div>
    </header>

    <div id="view-home" class="main-content">
        <div class="section-header"><i class="fa-solid fa-fire"></i> Hot Cases</div>
        <div class="cases-grid" id="cases-grid"></div>
    </div>

    <div id="view-battles" class="main-content hidden">
        <div class="section-header"><i class="fa-solid fa-swords"></i> Bot Battle 1v1</div>
        <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
            <p style="color: #888; margin-bottom: 10px; font-size: 13px;">Стоимость участия: 100.00</p>
            <button class="btn-action btn-green" onclick="startBattle()">CREATE BATTLE</button>
        </div>

        <div id="battle-interface" class="hidden">
            <div class="battle-container">
                <div class="battle-col" id="col-user">
                    <div class="battle-header">
                        <img id="user-avatar-battle" src="" class="avatar">
                        <span style="font-size: 12px; font-weight: bold;">YOU</span>
                        <span class="battle-total" id="total-user">0.00</span>
                    </div>
                    </div>
                <div class="battle-col" id="col-bot">
                    <div class="battle-header">
                        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" class="avatar">
                        <span style="font-size: 12px; font-weight: bold;">BOT</span>
                        <span class="battle-total" id="total-bot">0.00</span>
                    </div>
                    </div>
            </div>
            <div id="battle-result" style="text-align: center; margin-top: 20px; font-size: 20px; font-weight: 900; text-transform: uppercase;"></div>
        </div>
    </div>

    <div id="view-upgrade" class="main-content hidden">
        <div class="section-header"><i class="fa-solid fa-circle-up"></i> Upgrade Skins</div>
        
        <div class="upgrade-wrapper">
            <div style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #666;">BET</div>
                    <div style="font-size: 18px; font-weight: 700;">100.00</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #666;">WIN</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--accent-green);" id="upg-win-val">200.00</div>
                </div>
            </div>

            <div class="circle-container">
                <svg class="upgrade-svg">
                    <circle class="circle-bg" cx="130" cy="130" r="120"></circle>
                    <circle class="circle-progress" id="upg-circle" cx="130" cy="130" r="120"></circle>
                </svg>
                <div class="pointer" id="upg-pointer"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 32px; font-weight: 900;" id="upg-percent">50%</div>
                </div>
            </div>

            <div class="multipliers">
                <button class="mult-btn" onclick="setUpgrade(1.5)">x1.5</button>
                <button class="mult-btn active" onclick="setUpgrade(2)">x2</button>
                <button class="mult-btn" onclick="setUpgrade(5)">x5</button>
                <button class="mult-btn" onclick="setUpgrade(10)">x10</button>
            </div>

            <button class="btn-action btn-green" onclick="runUpgrade()">UPGRADE</button>
        </div>
    </div>

    <div id="view-profile" class="main-content hidden">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="profile-avatar" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent-green);">
            <h2 style="margin-top: 10px;" id="profile-name">User</h2>
            <div style="color: #666; font-size: 12px;">Inventory Value: <span style="color: var(--accent-green);" id="inv-value">0.00</span></div>
        </div>
        <div class="section-header">My Inventory</div>
        <div class="cases-grid" id="inventory-grid" style="grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
    </div>

    <div class="modal-overlay" id="roulette-modal">
        <div class="roulette-wrapper">
            <div class="roulette-center-line"></div>
            <div class="roulette-tape" id="roulette-tape"></div>
        </div>
        
        <div class="win-card" id="win-card">
            <div style="font-size: 16px; color: #aaa; margin-bottom: 10px;">YOU WON</div>
            <img id="win-img" src="" style="width: 150px; margin-bottom: 15px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));">
            <div id="win-name" style="font-size: 18px; font-weight: 800; text-transform: uppercase;">SKIN NAME</div>
            <div id="win-price" style="font-size: 16px; font-weight: 700; color: var(--accent-green); margin-bottom: 15px;">0.00</div>
            <button class="btn-action btn-green" onclick="closeRoulette()">KEEP</button>
            <button class="btn-action btn-sell" onclick="sellItem()">SELL</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="nav('home', this)">
            <i class="fa-solid fa-box-open"></i>
            <span>Cases</span>
        </div>
        <div class="nav-item" onclick="nav('battles', this)">
            <i class="fa-solid fa-users-slash"></i>
            <span>Battles</span>
        </div>
        <div class="nav-item" onclick="nav('upgrade', this)">
            <i class="fa-solid fa-arrow-trend-up"></i>
            <span>Upgrade</span>
        </div>
        <div class="nav-item" onclick="nav('profile', this)">
            <i class="fa-regular fa-user"></i>
            <span>Profile</span>
        </div>
    </nav>

<script>
    // --- INIT ---
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#1e1e24'); // Match panel color

    // --- DATA ---
    let balance = 500.00;
    let inventory = [];
    let upgradeMult = 2;
    
    // Real CS2 Skin Data (Images from Steam CDN)
    const SKINS = [
        { name: "AWP | Dragon Lore", price: 2500, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7cQFQq78dy27iR9tWmiQPj_0U9YmGid9eSI1c7MFvW_we6w-q618S575XAnCRj6yBw4X-OmAv330-J8wytYA/360fx360f" },
        { name: "M4A4 | Howl", price: 1800, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhz2v_Nfz5H_uO1gb-Gw_alIImJwlRc7cF4n-SPpI-i3Aew_0o5YT2iJNfHclM5YQzU_gK7wO7mg8C0u5rKzCdg7yYk5XfUmEeyhQYMMLIki7Zt0g/360fx360f" },
        { name: "AK-47 | Gold Arabesque", price: 1200, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjxszJemkV09-5lpKKqPv9NLPF2G0D78Y_3r2Z8I2i0Qq1_kFsY2z1d9CWelI2ZQqF-gS9w-a8h5S5vJ3MzSF9-n51Yx0r-Z4/360fx360f" },
        { name: "Karambit | Fade", price: 900, rarity: "r-gold", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLwJf0ebcZThQ6tCvq4GGqPP7I6vdk3lu-M1wmeyTyo78i0fvrxc5Mm_wI4fGcA89MlqB_FDrw-_ngpC5vpzJyyRiuSQm-z-DyBCA4k0T/360fx360f" },
        { name: "Glock-18 | Fade", price: 600, rarity: "r-purple", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgposbaqKAxf0v73efTH9eO7fYK0m_7zO6-fz2oI7pEjiLjHpo6n3g3t_kFtYTz1I46UJAQ-Y13Xq1Xvxe_v0cW5vJzJmnR9-n51-q3gWvI/360fx360f" },
        { name: "USP-S | Kill Confirmed", price: 150, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpoo6m1FBRp3_bGcjhQ09-jq5WYh8j_OrfdqWhe5sN4mTEyT48t2r2xK60x2Q/360fx360f" },
        { name: "AK-47 | Asiimov", price: 80, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjxszJemkV092lnYmGm_PLP7LWnn8f65dw3OyS942l3AGy80s4ZDygJOSWclQ3Ml_Q-lO8xua-jJK0uJvKz3Jj6yRz4i7D30vgF82Fm4E/360fx360f" },
        { name: "M4A1-S | Printstream", price: 120, rarity: "r-red", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhz2v_Nfz5H_uO1gb-Gw_alIImJwlRc7cF4n-SPpI-i3Aew_0o5YT2iJNfHclM5YQzU_gK7wO7mg8C0u5rKzCdg7yYk5XfUmEeyhQYMMLIki7Zt0g/360fx360f" },
        { name: "P250 | Asiimov", price: 15, rarity: "r-pink", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpopujwezhz3fzcdD5D09Lhh5O0h_L4PbzXmG9u5Mx2gv2P9I_zj126lBE9YmD0LI6QJgI4M1rR_VG6w-a70Z606pydwXsw7iInt33UgVXp1iE6l2r4/360fx360f" },
        { name: "AWP | Atheris", price: 10, rarity: "r-blue", img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJU5cy4gYyaqPjxhFlc5cN5t-rN_Iv9nB21rxFqY2r7coKRIFQ9ZgvU-1Pox-fv1p68u5mfmHsy6Sgg-z-DyIVN_-M0/360fx360f" }
    ];

    const CASES = [
        { id: 1, name: "Budget King", price: 20, img: "https://cdn-icons-png.flaticon.com/512/9329/9329199.png", pool: [9, 9, 8, 9, 6] },
        { id: 2, name: "Covert Ops", price: 150, img: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png", pool: [7, 5, 2, 7, 7] },
        { id: 3, name: "High Roller", price: 500, img: "https://cdn-icons-png.flaticon.com/512/644/644667.png", pool: [4, 2, 1, 3] },
        { id: 4, name: "Knife Club", price: 1000, img: "https://cdn-icons-png.flaticon.com/512/9626/9626643.png", pool: [3, 4, 1] }
    ];

    // --- SETUP ---
    function init() {
        const user = tg.initDataUnsafe.user;
        if(user) {
            document.getElementById('profile-name').textContent = user.first_name;
            if(user.photo_url) {
                document.getElementById('profile-avatar').src = user.photo_url;
                document.getElementById('user-avatar-battle').src = user.photo_url;
            }
        }
        
        updateBalance();
        renderCases();
        startLiveFeed();
    }

    function updateBalance() {
        document.getElementById('balance').textContent = balance.toFixed(2);
    }
    
    function addFunds() {
        balance += 1000;
        updateBalance();
        tg.showPopup({message: 'Пополнено на 1000.00 (Demo)'});
    }

    // --- RENDER CASES ---
    function renderCases() {
        const grid = document.getElementById('cases-grid');
        grid.innerHTML = CASES.map(c => `
            <div class="case-card" onclick="openCase(${c.id})">
                <img src="${c.img}" class="case-img">
                <div class="case-info">
                    <div class="case-name">${c.name}</div>
                    <div class="case-price">${c.price.toFixed(2)}</div>
                </div>
            </div>
        `).join('');
    }

    // --- LIVE FEED ---
    function startLiveFeed() {
        const track = document.getElementById('live-feed');
        // Pre-fill
        for(let i=0; i<20; i++) appendLiveItem(track);
        // Add new items occasionally
        setInterval(() => appendLiveItem(track), 2000);
    }

    function appendLiveItem(track) {
        const skin = SKINS[Math.floor(Math.random() * SKINS.length)];
        const div = document.createElement('div');
        div.className = 'live-item';
        div.innerHTML = `<img src="${skin.img}">`;
        div.style.borderBottomColor = getComputedStyle(document.body).getPropertyValue(`--rarity-${skin.rarity.replace('r-','')}`);
        track.insertBefore(div, track.firstChild);
        if(track.children.length > 30) track.removeChild(track.lastChild);
    }

    // --- ROULETTE LOGIC ---
    let currentWinItem = null;

    function openCase(id) {
        const caseObj = CASES.find(c => c.id === id);
        if(balance < caseObj.price) return tg.showAlert("Недостаточно средств");
        
        balance -= caseObj.price;
        updateBalance();

        const modal = document.getElementById('roulette-modal');
        const tape = document.getElementById('roulette-tape');
        const winCard = document.getElementById('win-card');
        
        modal.style.display = 'flex';
        winCard.classList.remove('visible');
        tape.style.transition = 'none';
        tape.style.transform = 'translateX(0)';

        // Generate Items
        let items = [];
        for(let i=0; i<50; i++) {
            let skinIdx = caseObj.pool[Math.floor(Math.random() * caseObj.pool.length)];
            items.push(SKINS[skinIdx]);
        }
        
        // Winner at index 40
        const WIN_IDX = 40;
        currentWinItem = items[WIN_IDX];
        
        tape.innerHTML = items.map(item => `
            <div class="tape-item ${item.rarity}">
                <img src="${item.img}">
            </div>
        `).join('');

        // Animate
        setTimeout(() => {
            const itemWidth = 120;
            const screenCenter = window.innerWidth / 2;
            const offset = (WIN_IDX * itemWidth) - screenCenter + (itemWidth / 2);
            // Random offset within item for realism
            const rand = Math.floor(Math.random() * 80) - 40; 
            
            tape.style.transition = 'transform 6s cubic-bezier(0.1, 0.85, 0.1, 1)';
            tape.style.transform = `translateX(-${offset + rand}px)`;
            
            // Haptic Feedback simulation on stop
            setTimeout(() => {
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                showWin(currentWinItem);
            }, 6000);
        }, 100);
    }

    function showWin(item) {
        document.getElementById('win-img').src = item.img;
        document.getElementById('win-name').innerText = item.name;
        document.getElementById('win-price').innerText = item.price.toFixed(2);
        const wc = document.getElementById('win-card');
        wc.style.borderBottom = `3px solid var(--${item.rarity.replace('r-','rarity-')})`;
        wc.classList.add('visible');
    }

    function closeRoulette() {
        inventory.push(currentWinItem);
        document.getElementById('roulette-modal').style.display = 'none';
        updateInventory();
    }

    function sellItem() {
        balance += currentWinItem.price;
        updateBalance();
        document.getElementById('roulette-modal').style.display = 'none';
        tg.showPopup({message: `Продано за ${currentWinItem.price}`});
    }

    // --- BATTLES LOGIC ---
    function startBattle() {
        if(balance < 100) return tg.showAlert("Нужно 100.00");
        balance -= 100;
        updateBalance();

        document.getElementById('battle-interface').classList.remove('hidden');
        document.getElementById('battle-result').innerText = "";
        
        const uCol = document.getElementById('col-user');
        const bCol = document.getElementById('col-bot');
        
        // Clear slots (keep header)
        while(uCol.children.length > 1) uCol.removeChild(uCol.lastChild);
        while(bCol.children.length > 1) bCol.removeChild(bCol.lastChild);

        let uTotal = 0, bTotal = 0;
        let round = 0;
        
        const interval = setInterval(() => {
            round++;
            const uSkin = SKINS[Math.floor(Math.random() * SKINS.length)];
            const bSkin = SKINS[Math.floor(Math.random() * SKINS.length)];
            
            uTotal += uSkin.price;
            bTotal += bSkin.price;

            document.getElementById('total-user').innerText = uTotal.toFixed(2);
            document.getElementById('total-bot').innerText = bTotal.toFixed(2);

            addBattleSlot(uCol, uSkin, uSkin.price > bSkin.price);
            addBattleSlot(bCol, bSkin, bSkin.price > uSkin.price);
            
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();

            if(round >= 5) {
                clearInterval(interval);
                setTimeout(() => {
                    const win = uTotal > bTotal;
                    const res = document.getElementById('battle-result');
                    res.innerText = win ? "YOU WIN" : "BOT WINS";
                    res.style.color = win ? "var(--accent-green)" : "var(--accent-red)";
                    
                    if(win) {
                        balance += (uTotal + bTotal);
                        updateBalance();
                        tg.HapticFeedback.notificationOccurred('success');
                    } else {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }, 1000);
            }
        }, 1500);
    }

    function addBattleSlot(col, skin, winner) {
        const div = document.createElement('div');
        div.className = `battle-slot ${winner ? 'winner' : 'loser'}`;
        div.innerHTML = `<img src="${skin.img}">`;
        col.appendChild(div);
    }

    // --- UPGRADE LOGIC ---
    function setUpgrade(m) {
        upgradeMult = m;
        document.querySelectorAll('.mult-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        const chance = (1 / m) * 0.95; // 5% house edge
        const pct = (chance * 100).toFixed(0);
        document.getElementById('upg-percent').innerText = pct + '%';
        document.getElementById('upg-win-val').innerText = (100 * m).toFixed(2);
        
        // Circle logic (Max stroke-dasharray = 753)
        const offset = 753 - (753 * chance);
        document.getElementById('upg-circle').style.strokeDashoffset = offset;
    }

    function runUpgrade() {
        if(balance < 100) return tg.showAlert("Ставка 100.00");
        balance -= 100;
        updateBalance();

        const ptr = document.getElementById('upg-pointer');
        const chance = (1 / upgradeMult) * 0.95;
        const win = Math.random() < chance;
        
        // Random landing angle
        let angle;
        if(win) angle = Math.random() * (360 * chance);
        else angle = (360 * chance) + Math.random() * (360 * (1-chance));
        
        const totalRot = 1440 + angle; // 4 spins
        
        ptr.style.transform = `rotate(${totalRot}deg)`;
        
        setTimeout(() => {
            if(win) {
                balance += 100 * upgradeMult;
                updateBalance();
                tg.showPopup({title:'УСПЕХ', message:`Выиграно ${100*upgradeMult}`});
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showPopup({title:'ПРОВАЛ', message:'Предмет сгорел'});
                tg.HapticFeedback.notificationOccurred('error');
            }
            // Reset
            ptr.style.transition = 'none';
            ptr.style.transform = 'rotate(0deg)';
            setTimeout(() => { ptr.style.transition = 'transform 4s cubic-bezier(0.1, 0.8, 0.1, 1)'; }, 100);
        }, 4000);
    }

    // --- UTILS ---
    function updateInventory() {
        const grid = document.getElementById('inventory-grid');
        grid.innerHTML = inventory.map(item => `
            <div class="case-card" style="padding:10px;">
                <img src="${item.img}" style="width:60px; height:40px; object-fit:contain;">
                <div style="font-size:10px; color:#aaa; margin-top:5px;">${item.name}</div>
                <div style="font-size:11px; font-weight:bold;">${item.price}</div>
            </div>
        `).join('');
        
        const total = inventory.reduce((acc, i) => acc + i.price, 0);
        document.getElementById('inv-value').innerText = total.toFixed(2);
    }

    function nav(view, el) {
        document.querySelectorAll('.main-content').forEach(d => d.classList.add('hidden'));
        document.getElementById('view-' + view).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }

    init();

</script>
</body>
</html>
